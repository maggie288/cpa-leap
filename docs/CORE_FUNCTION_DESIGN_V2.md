# CPA Leap 核心功能设计 V2

## 1. 目标与范围

- **目标**：从「可生成课时」升级为「可持续生产完整 CPA 课程」的生产级引擎。
- **口径**：中国 CPA（2026 考纲）为主，关键知识点提供 IFRS/US GAAP 对照层。
- **交付**：四层 AI 课程引擎 + 模型自动进化机制 + 知识自动更新闭环。

---

## 2. AI 课程引擎四层架构

### 2.1 SyllabusPlanner（考纲规划层）

**职责**：按科目自动生成「章节树 + 知识点图谱 + 难度路径」。

- **输入**：科目代码、考纲版本（如 2026）、可选前置约束。
- **输出**：
  - 章节树：`Chapter[]`（id, title, syllabusCode, order, estimatedHours）。
  - 知识点图谱：`KnowledgePoint[]`（id, chapterId, title, syllabusCode, prerequisites, examFrequency, difficulty）。
  - 难度路径：按先修关系与考试频率排序的学习顺序。
- **实现要点**：
  - 与知识库 `chapter` / `syllabusCode` 对齐，支持按考纲编码驱动目录生成。
  - 支持增量更新：新考纲发布时仅刷新变更章节与知识点。

### 2.2 LessonComposer（课时生成层）

**职责**：按知识点生成微课脚本、多题型题组、讲练复盘。

- **输入**：`knowledgePointId`、`chapterId`、`subject`、学员 `weakPoints`、可选 `examPoints`。
- **输出**：
  - 微课脚本：`lessonScript[]`（概念→规则→错因→应用）。
  - 题组：按题型配置生成（单选/多选/计算/综合/案例）。
  - 复习建议：`revisionTips[]`，与薄弱点绑定。
- **实现要点**：
  - 检索以「知识点 + 章节」为主键，再叠加关键词与薄弱点加权。
  - 支持单知识点多课时模板（概念课、规则课、错因课、综合课）。

### 2.3 QualityGate（质量门禁层）

**职责**：术语校验、法条/税率时效校验、答案一致性校验。

- **术语校验**：命中学科术语词典，非法术语或混淆词标记并降分或拦截。
- **时效校验**：税法/经济法条目绑定生效日/失效日；超出有效期的内容不得自动通过。
- **答案一致性**：题目答案与知识库 `rules`/`concept` 做一致性检查，冲突时标记人工复核。
- **输出**：`qualityScore`、`qualityIssues[]`、`passForGeneration`（布尔）。

### 2.4 LearningOptimizer（学习优化层）

**职责**：根据学员表现动态调节课时难度与题型配比。

- **输入**：学员历史完成记录、得分、错因分布、薄弱点列表。
- **输出**：
  - 推荐下一课时/知识点。
  - 题目难度与题型配比建议（供 LessonComposer 使用）。
  - 薄弱点权重（供检索与生成使用）。
- **实现要点**：
  - 与现有 `modelFeedback`、`weakPoints` 打通，提取 Top-K 薄弱点与错因聚类。
  - 可配置策略：如「连续错同一知识点则增加该点题量」。

---

## 3. 模型自动进化机制（Auto-Evolution）

### 3.1 Prompt 版本化

- **存储**：每个生成链路使用「Prompt 版本号 + 变更说明」。
- **字段**：`promptVersion`、`changelog`、`createdAt`、`owner`。
- **灰度**：新版本可配置流量比例（如 10%），与现有 A/B 分流共用 `trafficSplit`。

### 3.2 离线回放评测

- **固定题库**：维护一组「金标」题目与预期答案，每次模型/Prompt 变更后跑回归。
- **历史会话回放**：用历史 `lessonTitle + examPoints + weakPoints` 重新生成，对比新旧输出一致性与质量分。
- **门禁**：回归通过率/质量分不低于阈值方可上线新版本。

### 3.3 在线 A/B 评估

- **指标**：质量分、学习得分、完课率、错因分布。
- **统计**：按 `modelVersion` / `promptVersion` 聚合，支持显著性检验与置信区间（后续扩展）。
- **数据来源**：现有 `generationRuns`、`modelFeedback`。

### 3.4 自动晋升/降级策略

- **晋升**：当候选模型在 A/B 中「学习得分/完课率」显著优于当前主模型且质量分达标，可自动或半自动切换为主模型。
- **降级**：当主模型质量分或完课率连续 N 次低于阈值，自动回退到上一稳定版本。
- **配置**：晋升/降级阈值、冷却时间、需人工确认开关。

---

## 4. 知识自动更新机制（Auto-Knowledge Refresh）

### 4.1 来源分级

- **Level 1**：官方法规/准则（财政部、税务总局、证监会等）。
- **Level 2**：权威解读（官方解读、准则应用指南）。
- **Level 3**：教辅/教材（需人工抽检）。
- **策略**：同主题多来源时，高等级覆盖低等级；冲突时标记并送教师复核。

### 4.2 变更检测

- **新条目入库时**：与现有条目做「主题冲突/时间冲突」比对。
  - 主题冲突：同 `subject` + 相似 `topic`/`keywords` 的条目。
  - 时间冲突：同一政策/准则的新旧版本（通过 `effectiveAt`/`expiresAt` 或 `policyMeta` 判断）。
- **输出**：冲突对列表 + 建议操作（合并/替代/保留双版本送审）。

### 4.3 生命周期与时效

- **状态**：`draft` → `review` → `approved` → `deprecated`。
- **时效字段**：`effectiveAt`、`expiresAt`（可选），用于税法/经济法。
- **策略**：过期条目自动标记为 `deprecated` 或进入「修订建议」流程，不参与生成召回。

### 4.4 自动修订建议

- **触发**：政策抓取或人工入库时，命中既有知识点（同 syllabusCode 或高相似度）。
- **动作**：自动生成「修订建议草案」（diff 形式），送教师审核后合并或替换原条目。
- **审计**：保留修订历史（谁、何时、从何版本到何版本）。

---

## 5. 与现有组件的对应关系

| 能力 | 现有实现 | V2 升级方向 |
|------|----------|-------------|
| 考纲规划 | 无 | 新增 SyllabusPlanner，消费章节/知识点结构 |
| 课时生成 | `autonomousCourseEngine` + `generator` | LessonComposer 显式化，入参增加 chapterId/knowledgePointId |
| 质量门禁 | `scoring.js` + `quality.js` | QualityGate 增加术语与时效校验 |
| 学习优化 | `extractTopWeakPoints` + 注入生成 | LearningOptimizer 独立层，输出策略参数 |
| 模型进化 | A/B 分流 + 反馈存储 | 增加 Prompt 版本化、离线回放、自动晋升/降级 |
| 知识更新 | 政策抓取 + 入库 | 增加来源分级、冲突检测、时效、自动修订建议 |

---

## 6. 验收指标（与计划一致）

- **课程覆盖率**：六科高频考纲覆盖 ≥ 80%。
- **生成稳定性**：课程生成成功率 ≥ 99%。
- **质量门禁**：自动通过内容人工抽检合格率 ≥ 95%。
- **进化收益**：新模型相对基线在学习得分/完课率上显著提升。
- **知识时效**：政策变更后 48 小时内完成入库并进入课程引用链。
